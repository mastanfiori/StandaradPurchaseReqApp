/*
 * Copyright (C) 2009-2021 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["ui/ssuite/s2p/mm/pur/pr/prcss/s1/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","ui/ssuite/s2p/mm/pur/pr/prcss/s1/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox","sap/m/MessageStrip"],function(B,J,H,f,F,a,M){"use strict";var m=new sap.m.MessagePopoverItem({type:"{state}",title:"{name}",counter:"{aMessages.length}"});var o=new sap.m.MessagePopover({items:{path:'/',template:m}});return B.extend("ui.ssuite.s2p.mm.pur.pr.prcss.s1.controller.RFQPreview",{formatter:f,onInit:function(){this.selectedRFQDrafts=new Array();this.getRouter().getRoute("RFQPreview").attachPatternMatched(jQuery.proxy(function(e){var n=e.getParameter("name");if(n==="RFQPreview"){this.oApplicationModel=this.getModel();this.vRFQDraftId=e.getParameter('arguments').RFQid;this.sRFQDraftUrl="/C_RFQDraftForManagePurReqn(RFQDraftUUID=guid'"+this.vRFQDraftId+"')";this.refreshRFQdrafts();if(this.byId("idRFQSubmission").getValue()){this.byId("idRFQSubmission").setValue('');}}}),this);},refreshRFQdrafts:function(d,r){this.vActiveRFQNumber=null;var b=this.oApplicationModel;var p={urlParameters:{"$expand":"to_RFQItemDraftForManagePurReqn,to_RFQBidderDraftForMngPurReqn"},success:jQuery.proxy(this.onSuccessRFQDraftRead,this),error:jQuery.proxy(this.onErrorRequest,this)};b.read(this.sRFQDraftUrl,p);},comboFill:function(c){c.getSource().getBinding("items").resume();},onSuccessRFQDraftRead:function(r,d){this.byId("RFQObjectPageLayout").bindElement(this.sRFQDraftUrl);var R=d.data;if(!this.oldData){this.oldData=d.data;}if(!R){this.onNavBack();}},onErrorRequest:function(r,d){this.onNavBack();},onRFQTypeChange:function(e){},onChangeRFQDraft:function(e){var d=this.oApplicationModel;var s=e.getSource().getBindingContext();var p=this.getView().getModel().getProperty('PurchasingOrganization',s);var c=this.getView().getModel().getProperty('CompanyCode',s);var r=this.getView().getModel().getProperty('RFQDraftUUID',s);var R=this.getView().getModel().getProperty('RequestForQuotationName',s);var v=this.getView().getModel().getProperty('PurchasingDocumentType',s);var b=this.getView().byId("idRFQSubmission").getDateValue();var C=new Date();var S;if(b!==null){S=new Date(b);}else{S=null;}if(e.getSource().getId()===this.byId("idRFQSubmission").getId()){if(!e.getParameter("valid")){b=null;this.byId("idRFQSubmission").setValue('');}}if(b===null){this.getView().byId("idRFQSubmission").setValueState("Error");}else{S.setDate(b.getDate()+1);this.getView().byId("idRFQSubmission").setValueState("None");}if(v===""){this.getView().byId("idRFQTypes").setValueState("Error");}else{this.getView().byId("idRFQTypes").setValueState("None");}var P={'RFQDraftUUID':r,'QuotationLatestSubmissionDate':S,'RequestForQuotationName':R,'PurchasingDocumentType':v,'PurchasingOrganization':p,'CompanyCode':c};var g=new Object();g.success=jQuery.proxy(this.oSuccessUpdate,this);g.error=jQuery.proxy(this.onErrorUpdate,this);d.update(this.sRFQDraftUrl,P,g);},oSuccessUpdate:function(d,r){if(JSON.parse(r.headers['sap-message']).severity=='warning'||JSON.parse(r.headers['sap-message']).severity=='error'){}var i=0;if(r.headers['sap-message']==undefined)r=r.data.__batchResponses[0].__changeResponses[0];var b=JSON.parse(r.headers['sap-message']).details;var n=0;var c=new Array();var C={name:JSON.parse(r.headers['sap-message']).message,state:this._getMessageState(JSON.parse(r.headers['sap-message']).severity),icon:this._getMessageIcon(JSON.parse(r.headers['sap-message']).severity)};if(JSON.parse(r.headers['sap-message']).severity=='warning'||JSON.parse(r.headers['sap-message']).severity=='error'){c.push(C);n=n+1;}for(i=0;i<b.length;i++){var C={name:b[i].message,state:this._getMessageState(b[i].severity),icon:this._getMessageIcon(b[i].severity)};if((b[i].severity=='warning')||(b[i].severity=='error')){c.push(C);n=n+1;}}if(n>0){this.byId('idRFQMsgPopover').setVisible(true);this.oMessagePopover=this._getMessagePopover(c);}else{this.byId('idRFQMsgPopover').setVisible(false);}this.refreshRFQdrafts();},onPressAddBidder:function(e){if(!this.bidderFragment){this.bidderFragment=sap.ui.xmlfragment("ui.ssuite.s2p.mm.pur.pr.prcss.s1.fragment.BidderDialog",this);this.getView().addDependent(this.bidderFragment);this.bidderFragment.setRememberSelections(false);}var s=[];var S=e.getSource().getBindingContext();var p=this.getView().getModel().getProperty('PurchasingOrganization',S);var c=this.getView().getModel().getProperty('CompanyCode',S);s.push(new sap.ui.model.Filter("PurchasingOrganization","EQ",p));s.push(new sap.ui.model.Filter("CompanyCode","EQ",c));this.bidderFragment.getBinding("items").filter(s,"Application");jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this.bidderFragment);this.bidderFragment.open();},bidderclose:function(e){},onSearchBidder:function(e){var b=[];var q=e.getParameter('value');q.replace("*","");if(q&&q.length>0){var s=new sap.ui.model.Filter("Supplier",sap.ui.model.FilterOperator.Contains,q);var v=new sap.ui.model.Filter("SupplierName",sap.ui.model.FilterOperator.Contains,q);var A=new sap.ui.model.Filter("AddressID",sap.ui.model.FilterOperator.Contains,q);var c=new sap.ui.model.Filter("CityName",sap.ui.model.FilterOperator.Contains,q);var d=new sap.ui.model.Filter("CountryName",sap.ui.model.FilterOperator.Contains,q);var g=new sap.ui.model.Filter("PostalCode",sap.ui.model.FilterOperator.Contains,q);var p=new sap.ui.model.Filter("PhoneNumber",sap.ui.model.FilterOperator.Contains,q);var h=new sap.ui.model.Filter("EmailAddress",sap.ui.model.FilterOperator.Contains,q);var i=new sap.ui.model.Filter({filters:[s,v,A,c,d,g,p,h],and:false});b.push(i);}var l=sap.ui.getCore().byId("idBidderList");var j=l.getBinding("items");j.filter(b,"Application");},onPressOkBidder:function(e){var s=e.getParameter("selectedContexts");var c=new Array();if(s.length){var b=[];var d=this.oApplicationModel;for(var i=0;i<s.length;i++){var v=e.getParameter("selectedContexts")[i].getObject().Supplier;var u="/AddRFQBidders";var p={'Draftid':this.vRFQDraftId,'Supplier':v};d.callFunction(u,{method:"POST",urlParameters:p,success:jQuery.proxy(this.successBidderRefresh,this),error:jQuery.proxy(this.errorAddBidder,this)});}}this.bidderFragment.getBinding("items").filter([],"Application");this._getMessagePopover(c);},successBidderRefresh:function(){var d="/C_RFQDraftForManagePurReqn(RFQDraftUUID=guid'"+this.vRFQDraftId+"')";var p={urlParameters:{"$expand":"to_RFQItemDraftForManagePurReqn,to_RFQBidderDraftForMngPurReqn"},success:jQuery.proxy(this.onSuccessRFQDraftRequest,this),error:jQuery.proxy(this.onErrorRFQDraftRequest,this)};this.oApplicationModel.read(d,p);},handleBidderDelete:function(e){var r=e.getParameter('listItem').getBindingContext().sPath;var b=this.oApplicationModel;b.remove(r,{success:jQuery.proxy(this.successBidderRefresh,this)});},handleRFQDelete:function(e){var r=e.getParameter('listItem').getBindingContext().sPath;var b=this.oApplicationModel;b.remove(r,{success:jQuery.proxy(this.refreshRFQdrafts,this)});},onSuccessRFQDelete:function(){},fnRFQSave:function(e){var r=this.vActiveRFQNumber;var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(r!==undefined&&r!==null){c.toExternal({target:{semanticObject:"RequestForQuotation",action:"manage"},params:{RequestForQuotation:[r]}});}else{var b=[];var d=this.oApplicationModel;var u="/ActivateRFQ";var p={'Draftid':this.vRFQDraftId,'IsPublish':''};d.callFunction(u,{method:"POST",urlParameters:p,success:jQuery.proxy(this.successSaveRFQ,this),error:jQuery.proxy(this.errorCreateRFQ,this)});}},fnRFQPublish:function(){var t=this;this.oResourceBundle=this.getOwnerComponent().getModel('i18n').getResourceBundle();sap.m.MessageBox.show(this.oResourceBundle.getText("PublishMsg"),{icon:sap.m.MessageBox.Icon.CONFIRMATION,title:t.oResourceBundle.getText("PUBLISH"),actions:[t.oResourceBundle.getText("PUBLISH"),t.oResourceBundle.getText("Cancel")],onClose:function(A){if(A===t.oResourceBundle.getText("PUBLISH")){var b=[];var d=t.oApplicationModel;var u="/ActivateRFQ";var p={'Draftid':t.vRFQDraftId,'IsPublish':'X'};d.callFunction(u,{method:"POST",urlParameters:p,success:jQuery.proxy(t.successPublishRFQ,t),error:jQuery.proxy(t.errorCreateRFQ,t)});}},initialFocus:t.oResourceBundle.getText("PUBLISH")});},successPublishRFQ:function(d,r){var R=JSON.parse(r.headers['sap-message']).message;var p=JSON.parse(r.headers['sap-message']).code;var n=0;var N=true;var b=new Array();var c=new Array();if(p==="APPL_MM_PR/003"){var v=JSON.parse(r.headers['sap-message']).details.message;this.vActiveRFQNumber=v;var e={name:v,state:this._getMessageState(JSON.parse(r.headers['sap-message']).severity),icon:this._getMessageIcon(JSON.parse(r.headers['sap-message']).severity)};var g=new Array();g.push(e);this.byId('idRFQMsgPopover').setVisible(true);this.oMessagePopover=this._getMessagePopover();}else if(p==="APPL_MM_PR/001"){var t=this;var C=!!this.getView().$().closest(".sapUiSizeCompact").length;sap.m.MessageBox.success(R,{actions:[sap.m.MessageBox.Action.OK],styleClass:C?"sapUiSizeCompact":"",onClose:function(A){jQuery.sap.delayedCall(2000,this,function(){t.onNavBack();});}});}else{var i=0;var h=JSON.parse(r.headers['sap-message']).details;var j={name:JSON.parse(r.headers['sap-message']).message,state:this._getMessageState(JSON.parse(r.headers['sap-message']).severity),icon:this._getMessageIcon(JSON.parse(r.headers['sap-message']).severity)};if(JSON.parse(r.headers['sap-message']).severity=='warning'||JSON.parse(r.headers['sap-message']).severity=='error'){if((JSON.parse(r.headers['sap-message']).code)=='NO_NAV/100'&&(JSON.parse(r.headers['sap-message']).message)=='S:NO_NAV:100')N=false;else{c.push(j);n=n+1;}}for(i=0;i<h.length;i++){var j={name:h[i].message,state:this._getMessageState(h[i].severity),icon:this._getMessageIcon(h[i].severity)};if((h[i].severity=='warning')||(h[i].severity=='error')){if((h[i].code=='NO_NAV/100')&&(h[i].message=='S:NO_NAV:100')){N=false;}else{c.push(j);n=n+1;}}}var k=this._getMessagePopup(c,N,true);if(n>0){this.byId('idRFQMsgPopover').setVisible(true);this.oMessagePopover=this._getMessagePopover(c);jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),k);}else{this.byId('idRFQMsgPopover').setVisible(false);}}},successSaveRFQ:function(d,r){var c=JSON.parse(r.headers['sap-message']).details.length;var i=JSON.parse(r.headers['sap-message']).severity;var s=JSON.parse(r.headers['sap-message']).code;var C;if(this.vActiveRFQNumber){b.toExternal({target:{semanticObject:"RequestForQuotation",action:"manage"},params:{Requestforquotation:[this.vActiveRFQNumber]}});}if(s=="RFQId/101"){C=JSON.parse(r.headers['sap-message']).message;this.vActiveRFQNumber=C;}var b=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var n=0;var N=true;if(c>0||i==="error"){var e=0;var g=JSON.parse(r.headers['sap-message']).details;var h=new Array();var j={name:JSON.parse(r.headers['sap-message']).message,state:this._getMessageState(JSON.parse(r.headers['sap-message']).severity),icon:this._getMessageIcon(JSON.parse(r.headers['sap-message']).severity)};if(JSON.parse(r.headers['sap-message']).severity=='warning'||JSON.parse(r.headers['sap-message']).severity=='error'){if((JSON.parse(r.headers['sap-message']).code)=='NO_NAV/100'&&(JSON.parse(r.headers['sap-message']).message)=='S:NO_NAV:100')N=false;else{h.push(j);n=n+1;}}for(e=0;e<g.length;e++){var j={name:g[e].message,state:this._getMessageState(g[e].severity),icon:this._getMessageIcon(g[e].severity)};if((g[e].severity=='warning')||(g[e].severity=='error')){if((g[e].code=='NO_NAV/100')&&(g[e].message=='S:NO_NAV:100')){N=false;}else{h.push(j);n=n+1;}}}var k=this._getMessagePopup(h,N);if(n>0){this.byId("idMessageStrip").setVisible(true);this.byId('idRFQMsgPopover').setVisible(true);this.oMessagePopover=this._getMessagePopover(h);}else{b.toExternal({target:{semanticObject:"RequestForQuotation",action:"manage"},params:{RequestForQuotation:[this.vActiveRFQNumber]}});}}else{b.toExternal({target:{semanticObject:"RequestForQuotation",action:"manage"},params:{RequestForQuotation:[this.vActiveRFQNumber]}});}},_getMessageState:function(s){switch(s){case'error':return sap.ui.core.ValueState.Error;break;case'warning':return sap.ui.core.ValueState.Warning;break;case'success':return sap.ui.core.ValueState.Success;break;case'info':return sap.ui.core.ValueState.Success;break;}},_getMessageIcon:function(s){switch(s){case'error':return"sap-icon://error";break;case'warning':return"sap-icon://notification";break;case'success':return"sap-icon://sys-enter";break;case'info':return"sap-icon://sys-enter";break;}},_getMessagePopup:function(b,n,i){var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");var d={"messages":b};var t=new sap.m.Table({growing:true,inset:false,fixedLayout:false,backgroundDesign:sap.m.BackgroundDesign.Transparent,showSeparators:"Inner",columns:[new sap.m.Column({width:"25rem",styleClass:"name",hAlign:"Left",vAlign:"Top",})]});var g=new sap.m.ColumnListItem({unread:false,vAlign:"Top",cells:[new sap.ui.layout.Grid({vSpacing:0,hSpacing:1,content:[new sap.m.ObjectStatus({icon:"{icon}",state:"{state}",layoutData:new sap.ui.layout.GridData({span:"L2 M2 S2"})}),new sap.m.Text({text:"{name}",layoutData:new sap.ui.layout.GridData({span:"L10 M10 S10"})})]})]});var w=this.oRouter;var D=this.oApplicationModel;this.vNumberofMessages=d.messages.length;var h=new sap.ui.model.json.JSONModel();h.setData(d);t.setModel(h);t.bindAggregation("items","/messages",g);this.oMessageDialog=new sap.m.Dialog({content:[t],buttons:[new sap.m.Button({text:"{i18n>OK}",tap:jQuery.proxy(function(e){this.oMessageDialog.close();if(i==true){jQuery.sap.delayedCall(2000,this,function(){this.onNavBack();});}else{}},this),}),],state:"None",contentWidth:"25rem"});var j=this.getOwnerComponent().getModel('i18n').getResourceBundle().getText("MSG");this.oMessageDialog.setTitle(j+' ('+this.vNumberofMessages+')');this.getView().addDependent(this.oMessageDialog);this.oMessageDialog.addStyleClass("sapUiSizeCompact");return this.oMessageDialog;},handleNav:function(e){var s=e.getSource().getText().split("/");var p=s[0];var P=s[1];var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");c.toExternal({target:{semanticObject:"PurchaseRequisition",action:"maintain"},params:{PurchaseRequisition:[p],PurchaseRequisitionItem:[P]}});},_removeArrayValue:function(s,d){for(var i=0;i<s.length;i++){if(s[i].draftId==d){s.splice(i,1);}}},onNavBack:function(){window.history.go(-1);},_getMessagePopover:function(b){var c=new sap.ui.model.json.JSONModel();c.setData(b);var v=new sap.ui.model.json.JSONModel();v.setData({'results.messagesLength':b.length+''});this.byId('idRFQMsgPopover').setModel(v);return o.setModel(c);},handleMessagePopoverPress:function(e){if(this.getTestMode()===false){this.oMessagePopover.openBy(e.getSource());}},onPressEmailBidder:function(e){sap.m.URLHelper.triggerEmail(e.getSource().getText());},onNavToRFQ:function(e){var s=e.getSource().getBindingContext();var v=this.getView().getModel().getProperty('RFQDraftUUID',s);var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");c.toExternal({target:{semanticObject:"RequestForQuotation",action:"manage"},params:{RequestForQuotation:'',DraftUUID:v,IsActiveEntity:"false"}});}});});
